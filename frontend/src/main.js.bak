const { createApp } = Vue;
const { ElMessage, ElMessageBox, ElLoading } = ElementPlus;

// é…ç½®axios
//const api = axios.create({
//    baseURL: 'http://' + window.location.hostname + ':8000/api/',
//    timeout: 10000,
//});

// é…ç½®axios
const api = axios.create({
    baseURL: 'http://10.203.41.67:8000/api/',
    timeout: 10000,
    withCredentials: true,  // æ·»åŠ è¿™è¡Œ
    headers: {
        'X-Requested-With': 'XMLHttpRequest',
    }
});


// æ·»åŠ CSRF tokenå¤„ç†
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// è¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use(
    config => {
        const csrftoken = getCookie('csrftoken');
        if (csrftoken) {
            config.headers['X-CSRFToken'] = csrftoken;
        }
        return config;
    },
    error => {
        return Promise.reject(error);
    }
);


// è¯·æ±‚æ‹¦æˆªå™¨
//api.interceptors.request.use(
//    config => {
//        const token = localStorage.getItem('token');
//        if (token) {
//            config.headers.Authorization = `Token ${token}`;
//        }
//        return config;
//    },
//    error => {
//        return Promise.reject(error);
//    }
//);

// å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
    response => response,
    error => {
        if (error.response?.status === 401) {
            ElMessage.error('è¯·å…ˆç™»å½•');
            window.location.href = '/login.html';
        }
        return Promise.reject(error);
    }
);

const App = {
    data() {
        return {
            activeMenu: 'dashboard',
            isCollapse: false,
            stats: {
                today_count: 0,
                week_count: 0,
                month_count: 0,
                pass_rate: 0,
                need_recording: 0
            },
            interviews: [],
            statusStats: [],
            calendarData: [],
            currentView: 'dashboard'
        };
    },
    mounted() {
        this.loadDashboardData();
    },
    methods: {
        async loadDashboardData() {
            try {
                const loading = ElLoading.service({ fullscreen: true });
                
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [statsRes, interviewsRes, statusRes, calendarRes] = await Promise.all([
                    api.get('dashboard/stats/'),
                    api.get('interviews/'),
                    api.get('dashboard/stats/'),
                    api.get('dashboard/calendar/')
                ]);

                this.stats = statsRes.data;
                this.interviews = interviewsRes.data;
                this.statusStats = statusRes.data.status_stats;
                this.calendarData = calendarRes.data;
                
                loading.close();
            } catch (error) {
                ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥');
                console.error('Error loading data:', error);
            }
        },
        navigateTo(view) {
            this.currentView = view;
            if (view === 'dashboard') {
                this.loadDashboardData();
            }
        },
        getStatusType(status) {
            const typeMap = {
                'scheduled': 'primary',
                'in_progress': 'warning',
                'completed': 'success',
                'cancelled': 'danger',
                'passed': 'success',
                'rejected': 'danger',
                'pending': 'info',
                'offer': 'success',
                'declined': 'danger'
            };
            return typeMap[status] || 'info';
        },
        getStatusText(status) {
            const textMap = {
                'scheduled': 'å·²å®‰æ’',
                'in_progress': 'é¢è¯•ä¸­',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ',
                'passed': 'é€šè¿‡',
                'rejected': 'æœªé€šè¿‡',
                'pending': 'å¾…å®š',
                'offer': 'å‘æ”¾Offer',
                'declined': 'å·²æ‹’ç»'
            };
            return textMap[status] || status;
        },
        formatDateTime(datetime) {
            if (!datetime) return '';
            return new Date(datetime).toLocaleString('zh-CN');
        },
        async uploadRecording(interviewId) {
            try {
                const { value: file } = await ElMessageBox.prompt('è¯·é€‰æ‹©å½•éŸ³æ–‡ä»¶', 'ä¸Šä¼ å½•éŸ³', {
                    inputType: 'file',
                    inputPlaceholder: 'é€‰æ‹©æ–‡ä»¶'
                });
                
                if (file) {
                    const formData = new FormData();
                    formData.append('recording', file);
                    
                    await api.post(`interviews/${interviewId}/upload_recording/`, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    
                    ElMessage.success('å½•éŸ³ä¸Šä¼ æˆåŠŸ');
                    this.loadDashboardData();
                }
            } catch (error) {
                if (error !== 'cancel') {
                    ElMessage.error('ä¸Šä¼ å¤±è´¥');
                }
            }
        },
        async completeInterview(interviewId) {
            try {
                await ElMessageBox.confirm('ç¡®å®šè¦å®Œæˆè¿™ä¸ªé¢è¯•å—ï¼Ÿ', 'ç¡®è®¤å®Œæˆ', {
                    type: 'warning'
                });
                
                await api.post(`interviews/${interviewId}/complete_interview/`);
                ElMessage.success('é¢è¯•å·²å®Œæˆ');
                this.loadDashboardData();
            } catch (error) {
                if (error !== 'cancel') {
                    ElMessage.error('æ“ä½œå¤±è´¥');
                }
            }
        }
    },
    template: `
        <el-container style="height: 100vh;">
            <el-header>
                <div style="display: flex; align-items: center;">
                    <h1 style="margin: 0; font-size: 24px;">ğŸ¯ é¢è¯•ç®¡ç†å¹³å°</h1>
                </div>
                <div>
                    <el-button type="text" style="color: white;" @click="navigateTo('dashboard')">
                        é¦–é¡µ
                    </el-button>
                    <el-button type="text" style="color: white;" @click="navigateTo('interviews')">
                        é¢è¯•ç®¡ç†
                    </el-button>
                    <el-button type="text" style="color: white;" @click="navigateTo('stats')">
                        ç»Ÿè®¡åˆ†æ
                    </el-button>
                </div>
            </el-header>

            <el-container>
                <el-aside width="200px">
                    <el-menu
                        :default-active="activeMenu"
                        background-color="#304156"
                        text-color="#bfcbd9"
                        active-text-color="#409EFF"
                        router
                    >
                        <el-menu-item index="dashboard" @click="navigateTo('dashboard')">
                            <i class="el-icon-data-line"></i>
                            <span>æ•°æ®çœ‹æ¿</span>
                        </el-menu-item>
                        <el-menu-item index="interviews" @click="navigateTo('interviews')">
                            <i class="el-icon-date"></i>
                            <span>é¢è¯•ç®¡ç†</span>
                        </el-menu-item>
                        <el-menu-item index="stats" @click="navigateTo('stats')">
                            <i class="el-icon-s-data"></i>
                            <span>ç»Ÿè®¡åˆ†æ</span>
                        </el-menu-item>
                        <el-menu-item index="admin" @click="window.open('/admin/', '_blank')">
                            <i class="el-icon-s-tools"></i>
                            <span>ç®¡ç†åå°</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>

                <el-main>
                    <div v-if="currentView === 'dashboard'">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <el-row :gutter="20">
                            <el-col :span="6">
                                <div class="stat-card">
                                    <div class="stat-title">ä»Šæ—¥é¢è¯•</div>
                                    <div class="stat-value">{{ stats.today_count }}</div>
                                </div>
                            </el-col>
                            <el-col :span="6">
                                <div class="stat-card">
                                    <div class="stat-title">æœ¬å‘¨é¢è¯•</div>
                                    <div class="stat-value">{{ stats.week_count }}</div>
                                </div>
                            </el-col>
                            <el-col :span="6">
                                <div class="stat-card">
                                    <div class="stat-title">æœ¬æœˆé¢è¯•</div>
                                    <div class="stat-value">{{ stats.month_count }}</div>
                                </div>
                            </el-col>
                            <el-col :span="6">
                                <div class="stat-card">
                                    <div class="stat-title">é€šè¿‡ç‡</div>
                                    <div class="stat-value">{{ stats.pass_rate }}%</div>
                                </div>
                            </el-col>
                        </el-row>

                        <!-- é¢è¯•è¡¨æ ¼ -->
                        <div class="interview-table">
                            <h3>ä»Šæ—¥é¢è¯•å®‰æ’</h3>
                            <el-table :data="interviews" style="width: 100%">
                                <el-table-column prop="candidate_name" label="å€™é€‰äºº" width="120"></el-table-column>
                                <el-table-column prop="company_name" label="å…¬å¸" width="150"></el-table-column>
                                <el-table-column prop="position_title" label="èŒä½" width="150"></el-table-column>
                                <el-table-column label="é¢è¯•æ—¶é—´" width="180">
                                    <template #default="{row}">
                                        {{ formatDateTime(row.scheduled_time) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="çŠ¶æ€" width="100">
                                    <template #default="{row}">
                                        <el-tag :type="getStatusType(row.status)" class="status-tag">
                                            {{ getStatusText(row.status) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="ç»“æœ" width="100">
                                    <template #default="{row}">
                                        <el-tag :type="getStatusType(row.result)" class="status-tag">
                                            {{ getStatusText(row.result) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="æ“ä½œ" width="200">
                                    <template #default="{row}">
                                        <el-button 
                                            v-if="row.status === 'completed' && !row.recording_uploaded"
                                            size="small" 
                                            type="warning"
                                            @click="uploadRecording(row.id)"
                                        >
                                            ä¸Šä¼ å½•éŸ³
                                        </el-button>
                                        <el-button 
                                            v-if="row.status !== 'completed'"
                                            size="small" 
                                            type="primary"
                                            @click="completeInterview(row.id)"
                                        >
                                            å®Œæˆé¢è¯•
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>

                    <div v-else-if="currentView === 'interviews'">
                        <div class="dashboard-card">
                            <h3>é¢è¯•ç®¡ç†</h3>
                            <p>è¿™é‡Œå¯ä»¥æ˜¾ç¤ºæ‰€æœ‰é¢è¯•çš„è¯¦ç»†ç®¡ç†åŠŸèƒ½</p>
                        </div>
                    </div>

                    <div v-else-if="currentView === 'stats'">
                        <div class="dashboard-card">
                            <h3>ç»Ÿè®¡åˆ†æ</h3>
                            <p>è¿™é‡Œå¯ä»¥æ˜¾ç¤ºå„ç§ç»Ÿè®¡å›¾è¡¨å’Œåˆ†ææŠ¥å‘Š</p>
                        </div>
                    </div>
                </el-main>
            </el-container>
        </el-container>
    `
};

createApp(App).use(ElementPlus).mount('#app');
